# ==========================================
# CONFIGURAÇÃO NGINX - HAJAR IMÓVEIS
# Next.js em https://novo.hajar.com.br/
# ==========================================
# Cole esta configuração no CloudPanel: Sites → novo.hajar.com.br → Vhost

server {
  listen 80;
  listen [::]:80;
  listen 443 quic;
  listen 443 ssl;
  listen [::]:443 quic;
  listen [::]:443 ssl;
  http2 on;
  http3 off;
  {{ssl_certificate_key}}
  {{ssl_certificate}}
  server_name novo.hajar.com.br;

  {{nginx_access_log}}
  {{nginx_error_log}}

  # ==========================================
  # SEGURANÇA
  # ==========================================
  
  # Redirecionar HTTP para HTTPS
  if ($scheme != "https") {
    rewrite ^ https://$host$request_uri permanent;
  }

  # Headers de segurança
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;

  # Let's Encrypt
  location ~ /.well-known {
    auth_basic off;
    allow all;
  }

  {{settings}}

  # ==========================================
  # PROXY REVERSO PARA NEXT.JS (porta 3008)
  # ==========================================
  location / {
    proxy_pass http://127.0.0.1:3008;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # Timeouts para evitar 502
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }

  # ==========================================
  # CACHE AGRESSIVO PARA ARQUIVOS ESTÁTICOS DO NEXT.JS
  # ==========================================
  
  # Build estático do Next.js (nunca muda)
  location /_next/static/ {
    proxy_pass http://127.0.0.1:3008;
    proxy_cache_valid 200 365d;
    add_header Cache-Control "public, max-age=31536000, immutable";
    access_log off;
  }

  # Otimização de imagens do Next.js
  location /_next/image {
    proxy_pass http://127.0.0.1:3008;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_valid 200 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # Arquivos públicos (imagens, fontes, etc)
  location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|woff|woff2|ttf|eot|otf)$ {
    proxy_pass http://127.0.0.1:3008;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    access_log off;
  }

  # Arquivos JavaScript e CSS
  location ~* \.(js|css)$ {
    proxy_pass http://127.0.0.1:3008;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # ==========================================
  # SEO E SITEMAP
  # ==========================================
  
  # Sitemap e robots.txt (cache de 1 dia)
  location ~* ^/(sitemap\.xml|robots\.txt)$ {
    proxy_pass http://127.0.0.1:3008;
    expires 1d;
    add_header Cache-Control "public, max-age=86400";
  }

  # ==========================================
  # COMPRESSÃO GZIP
  # ==========================================
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_comp_level 6;
  gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/rss+xml
    application/atom+xml
    image/svg+xml;
}

